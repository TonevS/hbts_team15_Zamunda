<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <!-- Include the CesiumJS JavaScript and CSS files -->
    <script src="https://cesium.com/downloads/cesiumjs/releases/1.107/Build/Cesium/Cesium.js"></script>
    <link href="https://cesium.com/downloads/cesiumjs/releases/1.107/Build/Cesium/Widgets/widgets.css" rel="stylesheet">

    <style>
        .content-box {
            background-color: rgb(44, 44, 44);
            padding: 1em;
        }

        body {
            width: 100vw;
            height: 100vh;
            overflow: hidden;
        }

        .settingsContainer {
            position: absolute;
            display: flex;
            flex-direction: column;
            height: fit-content;
            left: 2em;
            top: -100px;
            z-index: 2;
        }

        .guessContainer {
            position: absolute;
            display: flex;
            width: 400px;
            right: 2em;
            z-index: 2;
        }

        .scoreContainer {
            position: absolute;
            flex-direction: column;
            width: 400px;
            left: calc(50% - 250px);
            filter: none;
            z-index: 4;
            bottom: -350px;
        }

        .advanceContainer {
            position: absolute;
            display: flex;
            flex-direction: column;
            width: 300px;
            left: calc(50% - 200px);
            bottom: 2em;
            left: -350px;
            ;
            z-index: 2;
        }

        .rounded {
            border-radius: 5px;
        }

        .finishedMap {

            filter: blur(1.5rem);
            background: gray;
            transition: opacity 1.5s ease;
        }
    </style>
</head>

<body style="position: relative; padding: 0px; margin:0">
    <div id="bg"></div>
    <div style="display: none;" id="guessesCorrectly">0</div>
    <div style="display: none;" id="nGuesses">5</div>
    <div id="scorePopup" class="content-box scoreContainer" style="display: none;">
        <p id="score"></p>
        <button id="nextRound" onclick="location.reload();">Next Round</button>
    </div>
    <div class="content-box settingsContainer">
        <button id="rotationButton">Stop</button>
        <button id="test">Stop</button>
        <select>
            <option value="building">Guess the Building</option>
            <option selected value="city">Guess the City</option>
            <option value="country">Guess the Country</option>
        </select>
    </div>
    <div id="cesiumContainer"></div>
    <div class="advanceContainer content-box">
        <span id="answer"></span>
        <p id="fun-fact"></p>
        <button id="advanceButton">Next</button>
    </div>
    <script type="module">
        import data from './building_data.json' assert { type: 'json' };

        // viewer.entities.add({
        //     position: Cesium.Cartesian3.fromDegrees(-73.9855, 40.7431, 15000),
        //     point: {
        //         show: true, // default
        //         color: Cesium.Color.YELLOW, // default: WHITE
        //         pixelSize: 10, // default: 1
        //     },
        // });
        // Cesium.Label.enableRightToLeftDetection = true;
        // const newYork = viewer.entities.add({
        //     position: Cesium.Cartesian3.fromDegrees(-73.9855, 40.7431, 150000),
        //     label: {
        //         id: 'my label',
        //         text: 'New York',
        //         font: '24px Helvetica',
        //         fillColor: Cesium.Color.YELLOW,
        //         outlineColor: Cesium.Color.BLACK,
        //         outlineWidth: 2,
        //         style: Cesium.LabelStyle.FILL_AND_OUTLINE,
        //         pixelOffset: new Cesium.Cartesian2(0, -9),
        //         eyeOffset: new Cesium.Cartesian3(0, 0, -9),
        //         horizontalOrigin: Cesium.HorizontalOrigin.CENTER,
        //         verticalOrigin: Cesium.VerticalOrigin.BOTTOM,
        //         heightReference: Cesium.HeightReference.CLAMP_TO_GROUND,
        //     },
        // });

        // viewer.entities.add({
        //     position: Cesium.Cartesian3.fromDegrees(3.6147, 51.4965, 15000),
        //     point: {
        //         show: true, // default
        //         color: Cesium.Color.YELLOW, // default: WHITE
        //         pixelSize: 10, // default: 1
        //         distanceDisplayCondition: new Cesium.DistanceDisplayCondition(0, 35000000), // default: undefined
        //     },
        // }); 

        // const middleburg = viewer.entities.add({
        //     position: Cesium.Cartesian3.fromDegrees(3.6147, 51.4965, 150000),
        //     label: {
        //         id: 'my label',
        //         text: 'Middleburg',
        //         font: '24px Helvetica',
        //         fillColor: Cesium.Color.YELLOW,
        //         outlineColor: Cesium.Color.BLACK,
        //         outlineWidth: 2,
        //         style: Cesium.LabelStyle.FILL_AND_OUTLINE,
        //         pixelOffset: new Cesium.Cartesian2(0, -9),
        //         eyeOffset: new Cesium.Cartesian3(0, 0, -9),
        //         horizontalOrigin: Cesium.HorizontalOrigin.CENTER,
        //         verticalOrigin: Cesium.VerticalOrigin.BOTTOM,
        //         heightReference: Cesium.HeightReference.CLAMP_TO_GROUND,
        //     },
        // });

        let state = true;
        let rndArray = [];
        for (let i = 0; i < 5; i++) {
            let rnd = Math.floor(Math.random() * data.buildings.length);
            if (rndArray.includes(data.buildings[rnd])) {
                i--;
            } else {
                rndArray.push(data.buildings[rnd]);
            }

        }
        Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiJmNzlhMGFmNy1hMjdmLTQxMTYtYWJlYS02ODIzNTVhN2FlYzYiLCJpZCI6MTUxOTAwLCJpYXQiOjE2ODg2NDQ3NzB9.-2WijF4n96t967UblqLZQGVJOo-eHw6CURVZP9qqblk';

        const viewer = new Cesium.Viewer("cesiumContainer", {
            globe: false,
        });

        try {
            const tileset = await Cesium.createGooglePhotorealistic3DTileset();
            viewer.scene.primitives.add(tileset);
        } catch (error) {
            console.log(`Failed to load tileset: ${error}`);
        }

        let buttonRotate = document.getElementById("rotationButton");
        buttonRotate.addEventListener("click", () => {
            state = !state;
        });


        function playRound(jsonArray, first = false) {
            const item = jsonArray.pop();
            console.log(item);
            state = false;
            main(item.longitude, item.latitude, item.height, item.distance, first);
            return item;
        }
        console.log('boom8')
        let usedArray = playRound(rndArray, true);
        console.log('boom9', usedArray)
        function gamemodeGuess(guessType, guess) {
            if (guessType == "building") {
                return guess === usedArray.name;
            } else if (guessType == "city") {
                return guess === usedArray.city;
            } else if (guessType == "country") {
                return guess === usedArray.country;
            }
        }
        async function main(longitude, latitude, height, distance, first = false) {
            // Usage!

            // Your access token can be found at: https://ion.cesium.com/tokens.
            // This is the default access token from your ion account


            function sleep(time) {
                return new Promise((resolve) => setTimeout(resolve, time));
            }

            function flyAnimation(long, lat, height) {
                let cameraLongtitude = Cesium.Math.toDegrees(viewer.camera.positionCartographic.longitude);
                let cameraLatitude = Cesium.Math.toDegrees(viewer.camera.positionCartographic.latitude);

                console.log(cameraLongtitude, cameraLatitude);
                long = parseFloat(long);
                lat = parseFloat(lat);
                height = parseFloat(height);
                if (!first) {
                    viewer.camera.flyTo({
                        destination: Cesium.Cartesian3.fromDegrees((long + cameraLongtitude) / 2, (lat + cameraLatitude) / 2 > 0 ? (lat + cameraLatitude) / 2 - 20 : (lat + cameraLatitude) / 2 + 20, 10000000),
                        orientation: {
                            heading: Cesium.Math.toRadians(0.0),
                            pitch: Cesium.Math.toRadians(-80.0),
                        },
                    })
                    setTimeout(flyDestination, 2500);
                } else {
                    flyDestination();
                }


                let heading = 0;
                let pitch = -0.3;
                const center = Cesium.Cartesian3.fromDegrees(longitude, latitude, height);

                // const transform = Cesium.Transforms.eastNorthUpToFixedFrame(center);
                console.log(distance);
                function flyDestination() {
                    viewer.camera.flyTo({
                        destination: Cesium.Cartesian3.fromDegrees(long, lat, height),
                        orientation: {
                            heading: Cesium.Math.toRadians(0.0),
                            pitch: Cesium.Math.toRadians(-35.0),
                        },
                        complete: function () {
                            state = true;
                            console.log(state);
                            setTimeout(() => {
                                viewer.clock.onTick.addEventListener(() => {
                                    if (state) {
                                        heading += 1 * (Math.PI / 2000);
                                        viewer.camera.lookAt(center, new Cesium.HeadingPitchRange(heading, pitch, distance));

                                    }
                                    const guessContainer = document.querySelector(".guessContainer");
                                    let botY = -50;
                                    const speed = 4; // Adjust the speed of movement

                                    const settingsContainer = document.querySelector(".settingsContainer");
                                    let topY = -50;

                                    function moveElementDown() {
                                        if (topY < 30) {
                                            topY += speed;
                                            settingsContainer.style.top = topY + 'px';
                                            requestAnimationFrame(moveElementDown);
                                        }

                                        return;
                                    }
                                    moveElementDown();

                                    function moveElementUp() {
                                        if (botY < 30) {
                                            botY += speed;
                                            guessContainer.style.bottom = botY + 'px';
                                            requestAnimationFrame(moveElementUp);
                                        }
                                        return;
                                    }
                                    moveElementUp();
                                });

                            }, 4000);
                        }
                    });
                }
            }
            flyAnimation(longitude, latitude, height);

            viewer.animation.container.style.visibility = 'hidden';
            viewer.timeline.container.style.visibility = 'hidden';
            viewer.forceResize();

            // Add Cesium OSM Buildings, a global 3D buildings layer.
            // const buildingTileset = await Cesium.createOsmBuildingsAsync();
            // viewer.scene.primitives.add(buildingTileset);   
        }
        let button = document.getElementById("guessButton");
        button.addEventListener("click", () => {

            const advanceContainer = document.querySelector(".advanceContainer");
            let leftX = -350;
            const speed = 16;

            function moveElementRight() {
                if (leftX < 30) {
                    leftX += speed;
                    advanceContainer.style.left = leftX + 'px';
                    requestAnimationFrame(moveElementRight);
                }

                return;
            }
            moveElementRight();




            let guess = document.getElementById("guessInput").value;
            let guessType = document.querySelector("select").value;

            const answer = document.getElementById("answer");
            if (gamemodeGuess(guessType, guess)) {
                answer.innerHTML = "Correct!";
                document.getElementById("guessesCorrectly").innerHTML = parseInt(document.getElementById("guessesCorrectly").innerHTML) + 1;
                document.getElementById("guessInput").innerHTML = "";
                console.log("GUESS WAS CORRECT :DDDDDD")
            } else {
                answer.innerHTML = "Incorrect!";
            }
            const fun_fact = document.getElementById("fun-fact");
            fun_fact.innerHTML = usedArray.fun_fact;

            document.getElementById("nGuesses").innerHTML = parseInt(document.getElementById("nGuesses").innerHTML) - 1;
            console.log(document.getElementById("nGuesses").innerHTML);
        });
        const buttonAdvance = document.getElementById("advanceButton");
        buttonAdvance.addEventListener('click', () => {
            if (document.getElementById("nGuesses").innerHTML == 0) {
                const map = document.getElementById("cesiumContainer");
                map.classList.add("finishedMap");


                document.getElementById("score").innerHTML = "Score: " + document.getElementById("guessesCorrectly").innerHTML + "/" + "5";

                const scoreContainer = document.querySelector(".scoreContainer");
                scoreContainer.style.display = "flex";
                let botY = -50;
                const speed = 8;
                function moveElementUp() {
                    if (botY < (window.innerHeight / 2) - 25) {
                        botY += speed;
                        scoreContainer.style.bottom = botY + 'px';
                        requestAnimationFrame(moveElementUp);
                    }
                    return;
                }
                moveElementUp();
            } else {
                usedArray = playRound(rndArray);
            }
            const guessContainer = document.querySelector(".guessContainer");
            let botY = 30;
            const speed = 4; // Adjust the speed of movement

            const settingsContainer = document.querySelector(".settingsContainer");
            let topY = 30;

            function moveElementUp() {
                if (topY >= -100) {
                    topY -= speed;
                    settingsContainer.style.top = topY + 'px';
                    requestAnimationFrame(moveElementUp);
                }

                return;
            }
            moveElementUp();

            function moveElementDown() {
                if (botY >= -100) {
                    botY -= speed;
                    guessContainer.style.bottom = botY + 'px';
                    requestAnimationFrame(moveElementDown);
                }
                return;
            }
            moveElementDown();


            const advanceContainer = document.querySelector(".advanceContainer");
            let leftX = 30;
            const advanceSpeed = 16;

            function moveElementLeft() {
                if (leftX >= -350) {
                    leftX -= advanceSpeed;
                    advanceContainer.style.left = leftX + 'px';
                    requestAnimationFrame(moveElementLeft);
                }

                return;
            }
            moveElementLeft();;
        });

    </script>
    <div class="content-box guessContainer" id="guessDiv">
        <input id="guessInput" placeholder="guess goes here">
        <button id="guessButton">Guess</button>
    </div>
</body>

</html>